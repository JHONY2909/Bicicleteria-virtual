{% extends 'base.html' %}
{% block title %}Gestionar Categorías - Bicicletería{% endblock %}
{% block content %}

<div class="form-container-centered">
    <div class="admin-header">
        <h1 class="admin-title">
            <i class="bi bi-tags-fill"></i> Gestionar Categorías y Subcategorías
        </h1>
        <p class="admin-subtitle">Organiza tu catálogo de productos</p>
    </div>

    <div class="admin-actions-centered">
        <a href="{{ url_for('dashboard.admin_panel') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver al Panel
        </a>
    </div>

    <!-- Agregar Nueva Categoría -->
    <div class="form-section-centered fade-in">
        <div class="form-section-header">
            <h3 class="form-section-title">
                <i class="bi bi-plus-circle"></i> Agregar Nueva Categoría
            </h3>
        </div>
        <div class="form-section-body">
            <form method="POST" action="" class="category-form">
                <div class="form-grid-compact">
                    <div class="form-group">
                        <label for="nombre_categoria" class="form-label">
                            <i class="bi bi-tag"></i> Nombre de la Categoría
                        </label>
                        <input type="text" class="form-control" id="nombre_categoria" name="nombre_categoria" required
                               placeholder="Ej: Bicicletas, Accesorios, Repuestos">
                    </div>
                    <div class="form-group">
                        <label for="nombre_subcategoria" class="form-label">
                            <i class="bi bi-tags"></i> Subcategoría (Opcional)
                        </label>
                        <input type="text" class="form-control" id="nombre_subcategoria" name="nombre_subcategoria"
                               placeholder="Ej: Montaña, Ruta, Urbana">
                        <small class="form-help">Si agregas una subcategoría, se creará automáticamente</small>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Agregar Categoría
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Agregar Subcategoría a Categoría Existente -->
    <div class="form-section-centered fade-in">
        <div class="form-section-header">
            <h3 class="form-section-title">
                <i class="bi bi-plus-square"></i> Agregar Subcategoría
            </h3>
        </div>
        <div class="form-section-body">
            <form method="POST" action="{{ url_for('dashboard.agregar_subcategoria') }}" class="category-form">
                <div class="form-grid-compact">
                    <div class="form-group">
                        <label for="categoria_id" class="form-label">
                            <i class="bi bi-list-ul"></i> Seleccionar Categoría
                        </label>
                        <select class="form-select" id="categoria_id" name="categoria_id" required>
                            <option value="">Selecciona una categoría</option>
                            {% for categoria in categorias %}
                                <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="nombre_subcategoria_2" class="form-label">
                            <i class="bi bi-tag"></i> Nombre de la Subcategoría
                        </label>
                        <input type="text" class="form-control" id="nombre_subcategoria_2" name="nombre_subcategoria" required
                               placeholder="Ej: BMX, Eléctrica, Híbrida">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Agregar Subcategoría
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lista de Categorías -->
    <div class="admin-table-container fade-in">
        <div class="admin-table-header">
            <h3 class="admin-table-title">
                <i class="bi bi-list"></i> Lista de Categorías
            </h3>
        </div>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Subcategorías</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% if categorias %}
                    {% for categoria in categorias %}
                        <tr>
                            <td><span class="badge badge-secondary">#{{ categoria.id }}</span></td>
                            <td>
                                <strong>{{ categoria.nombre }}</strong>
                            </td>
                            <td>
                                <span class="text-muted">
                                    {{ categoria.subcategorias|length if categoria.subcategorias else 0 }} subcategorías
                                </span>
                            </td>
                            <td>
                                <div class="table-actions">
                                    <button type="button" class="btn btn-danger btn-table delete-categoria-btn" 
                                            data-categoria-id="{{ categoria.id }}"
                                            data-categoria-nombre="{{ categoria.nombre }}">
                                        <i class="bi bi-trash"></i> Eliminar
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="4" class="empty-state">
                            <i class="bi bi-inbox" style="font-size: 2rem; opacity: 0.5;"></i>
                            <p>No hay categorías registradas.</p>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Lista de Subcategorías -->
    <div class="admin-table-container fade-in">
        <div class="admin-table-header">
            <h3 class="admin-table-title">
                <i class="bi bi-tags"></i> Lista de Subcategorías
            </h3>
        </div>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Categoría</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% if subcategorias %}
                    {% for subcategoria in subcategorias %}
                        <tr>
                            <td><span class="badge badge-secondary">#{{ subcategoria.id }}</span></td>
                            <td>{{ subcategoria.nombre }}</td>
                            <td>
                                <span class="badge badge-primary">{{ subcategoria.categoria.nombre }}</span>
                            </td>
                            <td>
                                <div class="table-actions">
                                    <button type="button" class="btn btn-danger btn-table delete-subcategoria-btn" 
                                            data-subcategoria-id="{{ subcategoria.id }}"
                                            data-subcategoria-nombre="{{ subcategoria.nombre }}">
                                        <i class="bi bi-trash"></i> Eliminar
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="4" class="empty-state">
                            <i class="bi bi-inbox" style="font-size: 2rem; opacity: 0.5;"></i>
                            <p>No hay subcategorías registradas.</p>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // Eliminar categoría
    document.querySelectorAll('.delete-categoria-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const categoriaId = this.getAttribute('data-categoria-id');
            const categoriaNombre = this.getAttribute('data-categoria-nombre');
            
            showDeleteConfirmation(
                `¿Estás seguro de que deseas eliminar la categoría "${categoriaNombre}"?`,
                'Esto eliminará todas sus subcategorías y productos asociados.',
                () => {
                    fetch(`/dashboard/admin/eliminar_categoria/${categoriaId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification(data.message, 'success');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            showNotification(data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('Error al eliminar la categoría', 'error');
                    });
                }
            );
        });
    });

    // Eliminar subcategoría
    document.querySelectorAll('.delete-subcategoria-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const subcategoriaId = this.getAttribute('data-subcategoria-id');
            const subcategoriaNombre = this.getAttribute('data-subcategoria-nombre');
            
            showDeleteConfirmation(
                `¿Estás seguro de que deseas eliminar la subcategoría "${subcategoriaNombre}"?`,
                'Esto eliminará todos los productos asociados.',
                () => {
                    fetch(`/dashboard/admin/eliminar_subcategoria/${subcategoriaId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification(data.message, 'success');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            showNotification(data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('Error al eliminar la subcategoría', 'error');
                    });
                }
            );
        });
    });

    // Función para mostrar confirmación de eliminación
    function showDeleteConfirmation(title, message, onConfirm) {
        const modal = document.createElement('div');
        modal.className = 'delete-confirmation';
        modal.innerHTML = `
            <div class="delete-modal">
                <h3><i class="bi bi-exclamation-triangle"></i> Confirmar Eliminación</h3>
                <p><strong>${title}</strong></p>
                <p class="text-muted">${message}</p>
                <div class="delete-modal-actions">
                    <button class="btn btn-secondary" onclick="this.closest('.delete-confirmation').remove()">
                        <i class="bi bi-x"></i> Cancelar
                    </button>
                    <button class="btn btn-danger" onclick="confirmDelete()">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        window.confirmDelete = function() {
            modal.remove();
            onConfirm();
        };
    }

    // Función para mostrar notificaciones
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.style.minWidth = '300px';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()">×</button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }
</script>

{% endblock %}
