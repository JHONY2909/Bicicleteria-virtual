{% extends 'base.html' %}
{% block title %}Catálogo - Bicicletería{% endblock %}
{% block content %}
<div class="container">
  <div class="hero">
    <div class="hero-background"></div>
    <div class="hero-content">
      <h1 class="hero-title">¡Bienvenido a nuestra Bicicletería!</h1>
      <p class="hero-subtitle">Descubre los mejores productos para tu bicicleta y vive la aventura sobre ruedas</p>
      {% if current_user.is_authenticated %}
        <p class="hero-text">¡Hola, {{ current_user.nombre_usuario }}! Explora nuestro catálogo.</p>
        <div class="hero-buttons">
          <a href="{{ url_for('dashboard.client_dashboard') }}" class="hero-btn hero-btn-primary">Explorar Productos</a>
          <a href="{{ url_for('cart.cart') }}" class="hero-btn hero-btn-primary">Ver Carrito</a>
        </div>
      {% else %}
        <p class="hero-text">¡Regístrate para comenzar a comprar!</p>
        <div class="hero-buttons">
          <a href="{{ url_for('auth.register') }}" class="hero-btn hero-btn-primary">Registrarse</a>
          <a href="{{ url_for('auth.login') }}" class="hero-btn hero-btn-outline">Iniciar Sesión</a>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Agregada sección de Nuestros Servicios -->
  <section class="services-section">
    <div class="container services-container">
      <div class="services-header">
        <h2 class="services-title">Nuestros Servicios</h2>
        <p class="services-subtitle">Ofrecemos servicios especializados para mantener tu bicicleta en perfectas condiciones y brindarte la mejor experiencia ciclística</p>
      </div>
      
      <div class="services-grid">
        <div class="service-card">
          <div class="service-icon">
            <i class="fas fa-tools"></i>
          </div>
          <h3 class="service-title">Mantenimiento Completo</h3>
          <p class="service-description">Revisión integral de tu bicicleta, ajuste de frenos, cambios y lubricación de componentes para un rendimiento óptimo.</p>
        </div>
        
        <div class="service-card">
          <div class="service-icon">
            <i class="fas fa-wrench"></i>
          </div>
          <h3 class="service-title">Reparaciones Especializadas</h3>
          <p class="service-description">Diagnóstico y reparación de averías complejas con técnicos especializados y repuestos originales de calidad.</p>
        </div>
        
        <div class="service-card">
          <div class="service-icon">
            <i class="fas fa-bicycle"></i>
          </div>
          <h3 class="service-title">Ensamblaje Personalizado</h3>
          <p class="service-description">Armado de bicicletas a medida según tus necesidades y preferencias, con asesoramiento profesional incluido.</p>
        </div>
        
        <div class="service-card">
          <div class="service-icon">
            <i class="fas fa-shipping-fast"></i>
          </div>
          <h3 class="service-title">Entrega a Domicilio</h3>
          <p class="service-description">Servicio de entrega rápida y segura de productos y bicicletas reparadas directamente en tu hogar.</p>
        </div>
        
        <div class="service-card">
          <div class="service-icon">
            <i class="fas fa-user-graduate"></i>
          </div>
          <h3 class="service-title">Asesoramiento Técnico</h3>
          <p class="service-description">Consultoría especializada para elegir la bicicleta perfecta y consejos de mantenimiento preventivo.</p>
        </div>
        
        <div class="service-card">
          <div class="service-icon">
            <i class="fas fa-shield-alt"></i>
          </div>
          <h3 class="service-title">Garantía Extendida</h3>
          <p class="service-description">Protección adicional para tus compras con garantía extendida y soporte técnico continuo.</p>
        </div>
      </div>
    </div>
  </section>

  <div class="section-header">
    <h2 class="section-title">Nuestro Catálogo</h2>
    <p class="section-subtitle">Encuentra todo lo que necesitas para tu bicicleta en un solo lugar</p>
  </div>

  <div class="search-container">
    <form class="search-form" action="{{ url_for('index') }}" method="get" id="searchForm">
      <div class="search-input-group">
        <input type="text" name="search" class="search-input" placeholder="Buscar" value="{{ search_query|default('') }}" id="searchInput">
        <button type="submit" class="search-btn">Buscar <i class="fas fa-search"></i></button>
        <a href="#" class="search-clear-btn" id="clearSearch" style="display: none;">×</a> <!-- Oculto por defecto, mostrado por JS -->
      </div>
    </form>
  </div>

  {% if search_query %}
    <div class="search-results-info">
      <i class="fas fa-info-circle"></i> Resultados para: "{{ search_query }}"
    </div>
  {% endif %}

  <div class="filters-container">
    <form class="filters-row" action="{{ url_for('index') }}" method="get">
      <div class="filter-group">
        <label for="category_id" class="filter-label">Categoría</label>
        <select name="category_id" id="category_id" class="filter-select" onchange="updateSubcategories(this)">
          <option value="">Todas las categorías</option>
          {% for category in categories %}
            <option value="{{ category.id }}" {% if selected_category_id == category.id|string %}selected{% endif %}>
              {{ category.nombre }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-group">
        <label for="subcategory_id" class="filter-label">Subcategoría</label>
        <select name="subcategory_id" id="subcategory_id" class="filter-select">
          <option value="">Todas las subcategorías</option>
          {% for subcategory in subcategories %}
            {% if selected_category_id and subcategory.categoria_id == selected_category_id|int %}
              <option value="{{ subcategory.id }}" {% if selected_subcategory_id == subcategory.id|string %}selected{% endif %}>
                {{ subcategory.nombre }}
              </option>
            {% elif not selected_category_id %}
              <option value="{{ subcategory.id }}" {% if selected_subcategory_id == subcategory.id|string %}selected{% endif %}>
                {{ subcategory.nombre }}
              </option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      {% if search_query %}
        <input type="hidden" name="search" value="{{ search_query }}">
      {% endif %}
      <button type="submit" class="filter-select btn btn-primary">Aplicar Filtros</button>
    </form>
  </div>

  <div class="products-grid">
    {% if products %}
      {% for product in products %}
        <div class="product-card">
          <div class="product-image-container">
            {% if product.url_imagen %}
              <img src="{{ product.url_imagen }}" alt="{{ product.nombre }}" class="product-image">
            {% else %}
              <img src="https://via.placeholder.com/200x200" alt="Placeholder" class="product-image">
            {% endif %}
          </div>
          <div class="product-badge">
            {% if product.stock < 10 and product.stock > 0 %}
              ¡Últimas unidades!
            {% elif product.stock == 0 %}
              Sin stock
            {% else %}
              {{ product.subcategoria.nombre if product.subcategoria else 'Producto' }}
            {% endif %}
          </div>
          <div class="product-info">
            <p class="product-category">{{ product.subcategoria.nombre if product.subcategoria else 'Sin categoría' }}</p>
            <h3 class="product-title">{{ product.nombre }}</h3>
            <p class="product-description">{{ product.descripcion }}</p>
            <p class="product-price">${{ "%.2f"|format(product.precio) }}</p>
            <p class="product-stock">
              {% if product.stock > 0 %}
                Stock: {{ product.stock }} unidades
              {% else %}
                Sin stock disponible
              {% endif %}
            </p>
            <div class="product-actions">
              {% if current_user.is_authenticated %}
                <button class="add-to-cart-btn btn btn-primary" {% if product.stock == 0 %}disabled{% endif %} data-product-id="{{ product.id }}">
                  {% if product.stock == 0 %}Sin Stock{% else %}Agregar al Carrito{% endif %}
                </button>
                <button class="wishlist-btn btn" {% if product.id in favorites %}class="favorited"{% endif %} data-product-id="{{ product.id }}">
                  <i class="fas fa-heart"></i>
                </button>
              {% else %}
                <a href="{{ url_for('auth.login') }}" class="add-to-cart-btn btn btn-primary">Agregar al Carrito</a>
                <a href="{{ url_for('auth.login') }}" class="wishlist-btn btn"><i class="fas fa-heart"></i></a>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="empty-state">
        <i class="fas fa-box-open empty-state-icon"></i>
        <h3 class="empty-state-title">No se encontraron productos</h3>
        <p class="empty-state-description">
          {% if search_query %}
            No encontramos productos que coincidan con tu búsqueda.
          {% else %}
            Intenta ajustar los filtros o explora otras categorías.
          {% endif %}
        </p>
        <a href="{{ url_for('index') }}" class="btn btn-primary">Ver todos los productos</a>
      </div>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearSearch');
    const searchForm = document.getElementById('searchForm');

    // Mostrar u ocultar el botón de limpiar según el contenido
    searchInput.addEventListener('input', function() {
      if (searchInput.value.trim() !== '') {
        clearBtn.style.display = 'flex'; // Mostrar la X
      } else {
        clearBtn.style.display = 'none'; // Ocultar la X
      }
    });

    // Limpiar el input y recargar la página sin búsqueda
    clearBtn.addEventListener('click', function(e) {
      e.preventDefault(); // Evitar el comportamiento predeterminado del enlace
      searchInput.value = ''; // Limpiar el input
      clearBtn.style.display = 'none'; // Ocultar el botón de limpiar
      searchForm.submit(); // Enviar el formulario vacío para mostrar todos los productos
    });

    // Mostrar la X si hay un search_query inicial
    if ('{{ search_query }}' !== '') {
      clearBtn.style.display = 'flex';
    }
  });
</script>
{% endblock %}
