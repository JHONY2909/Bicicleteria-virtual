{% extends 'base_admin.html' %}
{% block title %}Editar Producto - Bicicletería{% endblock %}
{% block content %}

<div class="admin-panel">
    <!-- Header mejorado -->
    <div class="page-header-modern">
        <div class="page-header-content">
            <div class="page-header-icon">
                <i class="bi bi-pencil-square"></i>
            </div>
            <div class="page-header-text">
                <h1 class="page-title">Editar Producto</h1>
                <p class="page-subtitle">Modifica la información del producto en el catálogo</p>
            </div>
        </div>
        <div class="page-header-actions">
            <a href="{{ url_for('dashboard.productos') }}" class="btn btn-outline">
                <i class="bi bi-arrow-left"></i> Volver a Productos
            </a>
        </div>
    </div>

    <div class="edit-product-layout">
        <!-- Formulario de edición -->
        <div class="edit-form-container">
            <div class="form-card">
                <div class="form-card-header">
                    <h3 class="form-card-title">
                        <i class="bi bi-box-seam"></i>
                        Información del Producto
                    </h3>
                    <p class="form-card-subtitle">Actualiza los detalles del producto</p>
                </div>
                
                <div class="form-card-body">
                    <form method="POST" action="{{ url_for('dashboard.editar_producto', product_id=product.id) }}" id="editProductForm">
                        <div class="form-grid-2">
                            <div class="form-group-modern">
                                <label for="nombre" class="form-label-modern">
                                    <i class="bi bi-tag"></i>
                                    Nombre del Producto
                                </label>
                                <input type="text" class="form-input-modern" id="nombre" name="nombre" 
                                       value="{{ product.nombre }}" required 
                                       placeholder="Ej: Bicicleta de Montaña">
                                <div class="form-feedback" id="nombreFeedback"></div>
                            </div>

                            <div class="form-group-modern">
                                <label for="precio" class="form-label-modern">
                                    <i class="bi bi-currency-dollar"></i>
                                    Precio
                                </label>
                                <input type="number" step="0.01" class="form-input-modern" id="precio" name="precio" 
                                       value="{{ product.precio }}" required min="0"
                                       placeholder="0.00">
                                <div class="form-feedback" id="precioFeedback"></div>
                            </div>
                        </div>

                        <div class="form-grid-2">
                            <div class="form-group-modern">
                                <label for="stock" class="form-label-modern">
                                    <i class="bi bi-boxes"></i>
                                    Stock Disponible
                                </label>
                                <input type="number" class="form-input-modern" id="stock" name="stock" 
                                       value="{{ product.stock }}" required min="0"
                                       placeholder="0">
                                <div class="form-feedback" id="stockFeedback"></div>
                            </div>

                            <div class="form-group-modern">
                                <label for="subcategoria_id" class="form-label-modern">
                                    <i class="bi bi-tags"></i>
                                    Subcategoría
                                </label>
                                <select class="form-select-modern" id="subcategoria_id" name="subcategoria_id" required>
                                    <option value="">Selecciona una subcategoría</option>
                                    {% for categoria in categorias %}
                                        <optgroup label="{{ categoria.nombre }}">
                                            {% for subcategoria in categoria.subcategorias %}
                                                <option value="{{ subcategoria.id }}" 
                                                        {% if subcategoria.id == product.subcategoria_id %}selected{% endif %}>
                                                    {{ subcategoria.nombre }}
                                                </option>
                                            {% endfor %}
                                        </optgroup>
                                    {% endfor %}
                                </select>
                                <div class="form-feedback" id="subcategoriaFeedback"></div>
                            </div>
                        </div>

                        <div class="form-group-modern">
                            <label for="descripcion" class="form-label-modern">
                                <i class="bi bi-card-text"></i>
                                Descripción
                            </label>
                            <textarea class="form-textarea-modern" id="descripcion" name="descripcion" rows="4"
                                      placeholder="Describe las características principales del producto...">{{ product.descripcion }}</textarea>
                            <div class="form-feedback" id="descripcionFeedback"></div>
                        </div>

                        <div class="form-group-modern">
                            <label for="url_imagen" class="form-label-modern">
                                <i class="bi bi-image"></i>
                                URL de la Imagen
                            </label>
                            <input type="url" class="form-input-modern" id="url_imagen" name="url_imagen" 
                                   value="{{ product.url_imagen }}"
                                   placeholder="https://ejemplo.com/imagen.jpg">
                            <div class="form-help">Ingresa la URL completa de la imagen del producto</div>
                            <div class="form-feedback" id="imagenFeedback"></div>
                        </div>

                        <div class="form-actions-modern">
                            <button type="submit" class="btn btn-primary-modern">
                                <i class="bi bi-check-circle"></i>
                                Guardar Cambios
                            </button>
                            <a href="{{ url_for('dashboard.productos') }}" class="btn btn-secondary-modern">
                                <i class="bi bi-x-circle"></i>
                                Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Vista previa mejorada -->
        <div class="preview-container">
            <div class="preview-card">
                <div class="preview-card-header">
                    <h3 class="preview-card-title">
                        <i class="bi bi-eye"></i>
                        Vista Previa
                    </h3>
                    <div class="preview-status" id="previewStatus">
                        <i class="bi bi-circle-fill"></i>
                        Actualizando...
                    </div>
                </div>
                
                <div class="preview-card-body">
                    <div class="product-preview-modern" id="productPreview">
                        <div class="preview-product-card">
                            <div class="preview-product-image-container">
                                <img id="previewImage" src="{{ product.url_imagen or '/static/images/placeholder.png' }}" 
                                     class="preview-product-image" alt="Vista previa">
                                <div class="preview-product-badge" id="previewCategory">
                                    {{ product.subcategoria.nombre if product.subcategoria else 'Categoría' }}
                                </div>
                                <div class="preview-stock-indicator" id="previewStockIndicator">
                                    <i class="bi bi-boxes"></i>
                                </div>
                            </div>
                            <div class="preview-product-info">
                                <div class="preview-product-category" id="previewSubcategory">
                                    {{ product.subcategoria.nombre if product.subcategoria else 'Subcategoría' }}
                                </div>
                                <h3 class="preview-product-title" id="previewName">{{ product.nombre }}</h3>
                                <p class="preview-product-description" id="previewDescription">{{ product.descripcion }}</p>
                                <div class="preview-product-footer">
                                    <div class="preview-product-price" id="previewPrice">${{ "%.2f"|format(product.precio) }}</div>
                                    <div class="preview-product-stock" id="previewStock">
                                        <i class="bi bi-boxes"></i>
                                        {{ product.stock }} unidades
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const form = document.getElementById('editProductForm');
    const inputs = {
        nombre: document.getElementById('nombre'),
        descripcion: document.getElementById('descripcion'),
        precio: document.getElementById('precio'),
        stock: document.getElementById('stock'),
        imagen: document.getElementById('url_imagen'),
        subcategoria: document.getElementById('subcategoria_id')
    };

    const preview = {
        name: document.getElementById('previewName'),
        description: document.getElementById('previewDescription'),
        price: document.getElementById('previewPrice'),
        stock: document.getElementById('previewStock'),
        image: document.getElementById('previewImage'),
        subcategory: document.getElementById('previewSubcategory'),
        category: document.getElementById('previewCategory'),
        stockIndicator: document.getElementById('previewStockIndicator'),
        status: document.getElementById('previewStatus')
    };

    let updateTimeout;

    function updatePreview() {
        clearTimeout(updateTimeout);
        preview.status.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Actualizando...';
        preview.status.className = 'preview-status updating';

        updateTimeout = setTimeout(() => {
            // Actualizar nombre
            preview.name.textContent = inputs.nombre.value || 'Nombre del producto';
            
            // Actualizar descripción
            preview.description.textContent = inputs.descripcion.value || 'Descripción del producto...';
            
            // Actualizar precio
            const precio = parseFloat(inputs.precio.value) || 0;
            preview.price.textContent = '$' + precio.toFixed(2);
            
            // Actualizar stock
            const stock = parseInt(inputs.stock.value) || 0;
            preview.stock.innerHTML = `<i class="bi bi-boxes"></i> ${stock} unidades`;
            
            // Actualizar indicador de stock
            if (stock === 0) {
                preview.stockIndicator.className = 'preview-stock-indicator out-of-stock';
                preview.stockIndicator.innerHTML = '<i class="bi bi-x-circle"></i>';
            } else if (stock < 10) {
                preview.stockIndicator.className = 'preview-stock-indicator low-stock';
                preview.stockIndicator.innerHTML = '<i class="bi bi-exclamation-triangle"></i>';
            } else {
                preview.stockIndicator.className = 'preview-stock-indicator in-stock';
                preview.stockIndicator.innerHTML = '<i class="bi bi-check-circle"></i>';
            }
            
            // Actualizar imagen
            if (inputs.imagen.value) {
                preview.image.src = inputs.imagen.value;
            } else {
                preview.image.src = '/static/images/placeholder.png';
            }

            // Actualizar subcategoría
            const selectedOption = inputs.subcategoria.options[inputs.subcategoria.selectedIndex];
            if (selectedOption && selectedOption.value) {
                preview.subcategory.textContent = selectedOption.textContent;
                preview.category.textContent = selectedOption.textContent;
            } else {
                preview.subcategory.textContent = 'Subcategoría';
                preview.category.textContent = 'Categoría';
            }

            preview.status.innerHTML = '<i class="bi bi-check-circle"></i> Actualizado';
            preview.status.className = 'preview-status updated';
        }, 300);
    }

    // Event listeners
    Object.values(inputs).forEach(input => {
        input.addEventListener('input', updatePreview);
        input.addEventListener('change', updatePreview);
    });

    // Validación de imagen mejorada
    inputs.imagen.addEventListener('blur', function() {
        const feedback = document.getElementById('imagenFeedback');
        if (this.value) {
            const img = new Image();
            img.onload = function() {
                feedback.textContent = 'Imagen válida';
                feedback.className = 'form-feedback success';
                preview.image.src = inputs.imagen.value;
            };
            img.onerror = function() {
                feedback.textContent = 'La URL de la imagen no es válida';
                feedback.className = 'form-feedback error';
                preview.image.src = '/static/images/placeholder.png';
            };
            img.src = this.value;
        } else {
            feedback.textContent = '';
            feedback.className = 'form-feedback';
        }
    });

    // Validación del formulario mejorada
    form.addEventListener('submit', function(e) {
        let isValid = true;
        const feedbacks = {};

        // Validar nombre
        if (!inputs.nombre.value.trim()) {
            feedbacks.nombre = { message: 'El nombre es requerido', type: 'error' };
            isValid = false;
        } else if (inputs.nombre.value.length < 3) {
            feedbacks.nombre = { message: 'El nombre debe tener al menos 3 caracteres', type: 'error' };
            isValid = false;
        } else {
            feedbacks.nombre = { message: 'Nombre válido', type: 'success' };
        }

        // Validar precio
        const precio = parseFloat(inputs.precio.value);
        if (isNaN(precio) || precio < 0) {
            feedbacks.precio = { message: 'El precio debe ser un número positivo', type: 'error' };
            isValid = false;
        } else {
            feedbacks.precio = { message: 'Precio válido', type: 'success' };
        }

        // Validar stock
        const stock = parseInt(inputs.stock.value);
        if (isNaN(stock) || stock < 0) {
            feedbacks.stock = { message: 'El stock debe ser un número positivo', type: 'error' };
            isValid = false;
        } else {
            feedbacks.stock = { message: 'Stock válido', type: 'success' };
        }

        // Validar subcategoría
        if (!inputs.subcategoria.value) {
            feedbacks.subcategoria = { message: 'Debes seleccionar una subcategoría', type: 'error' };
            isValid = false;
        } else {
            feedbacks.subcategoria = { message: 'Subcategoría seleccionada', type: 'success' };
        }

        // Mostrar feedback
        Object.keys(feedbacks).forEach(key => {
            const feedbackElement = document.getElementById(key + 'Feedback');
            if (feedbackElement) {
                feedbackElement.textContent = feedbacks[key].message;
                feedbackElement.className = `form-feedback ${feedbacks[key].type}`;
            }
        });

        if (!isValid) {
            e.preventDefault();
            // Scroll al primer error
            const firstError = document.querySelector('.form-feedback.error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });

    // Inicializar vista previa
    updatePreview();
</script>

{% endblock %}
