{% extends 'base.html' %}
{% block title %}Panel de {{ rol|title }} - Bicicleter√≠a{% endblock %}
{% block content %}

<div class="container py-6">
    <div class="admin-header">
        <h1 class="admin-title">
            {% if rol == 'cliente' %}
                
            {% elif rol == 'vendedor' %}
                <i class="bi bi-shop"></i> Panel de Vendedor
            {% else %}
                <i class="bi bi-gear-fill"></i> Panel de {{ rol|title }}
            {% endif %}
        </h1>
        <p class="admin-subtitle">
            {% if rol == 'cliente' %}
        
            {% elif rol == 'vendedor' %}
                Administra los pedidos y ventas
            {% else %}
                Panel de administraci√≥n de {{ rol }}
            {% endif %}
        </p>
    </div>

    {% if rol == 'cliente' %}
        <div class="flex gap-6">
            <!-- Sidebar simplificado sin perfil ni acciones r√°pidas -->
            <aside class="hidden md:block w-64 space-y-4">
                <!-- Pedidos recientes -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="bi bi-bag-check"></i> Pedidos Recientes
                        </h3>
                    </div>
                    <div class="card-body">
                        {% if pedidos %}
                            <div class="space-y-3">
                                {% for pedido in pedidos[:3] %}
                                    <div class="border-b pb-2 last:border-b-0">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="font-medium text-sm">Pedido #{{ pedido.id }}</p>
                                                <p class="text-xs text-muted">${{ "%.2f"|format(pedido.monto_total) }}</p>
                                            </div>
                                            <span class="status-badge status-{{ pedido.estado }} text-xs">
                                                {{ pedido.estado|title }}
                                            </span>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            {% if pedidos|length > 3 %}
                                <div class="mt-3 pt-3 border-t">
                                    <a href="#" class="text-primary text-sm hover:underline">
                                        Ver todos los pedidos
                                    </a>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-bag-x text-2xl text-muted opacity-50"></i>
                                <p class="text-sm text-muted mt-2">No tienes pedidos a√∫n</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Estad√≠sticas del usuario -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="bi bi-graph-up"></i> Mis Estad√≠sticas
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-sm text-muted">Pedidos:</span>
                                <span class="font-semibold">{{ pedidos|length }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-muted">Total gastado:</span>
                                <span class="font-semibold text-primary">
                                    ${{ "%.2f"|format(pedidos|sum(attribute='monto_total') if pedidos else 0) }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Contenido principal -->
            <main class="flex-1">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-2">Cat√°logo de Productos</h2>
                    <p class="text-muted">Encuentra todo lo que necesitas para tu bicicleta</p>
                </div>

                <!-- Barra de b√∫squeda -->
                <div class="search-container">
                    <form method="GET" action="{{ url_for('dashboard.client_dashboard') }}" class="search-form">
                        <div class="search-input-group">
                            <input type="text" name="search" class="search-input" 
                                   placeholder="Buscar productos por nombre, descripci√≥n o categor√≠a..." 
                                   value="{{ request.args.get('search', '') }}">
                            <button type="submit" class="search-btn">
                                <i class="bi bi-search"></i>
                            </button>
                            {% if request.args.get('search') %}
                                <a href="{{ url_for('dashboard.client_dashboard') }}" class="search-clear-btn" title="Limpiar b√∫squeda">
                                    <i class="bi bi-x"></i>
                                </a>
                            {% endif %}
                        </div>
                    </form>
                    {% if request.args.get('search') %}
                        <div class="search-results-info">
                            <span class="text-muted">
                                <i class="bi bi-search"></i> 
                                Resultados para: "<strong>{{ request.args.get('search') }}</strong>"
                            </span>
                        </div>
                    {% endif %}
                </div>

                <!-- Filtros -->
                <div class="filters-container">
                    <form method="POST" id="filter-form">
                        <div class="filters-row">
                            <div class="filter-group">
                                <label for="category_id" class="filter-label">
                                    <i class="bi bi-funnel"></i> Filtrar por Categor√≠a
                                </label>
                                <select name="category_id" id="category_id" class="filter-select" onchange="this.form.submit()">
                                    <option value="">Todas las categor√≠as</option>
                                    {% for category in categories %}
                                        <option value="{{ category.id }}" {% if selected_category_id == category.id|string %}selected{% endif %}>
                                            {{ category.nombre }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="subcategory_id" class="filter-label">
                                    <i class="bi bi-tags"></i> Filtrar por Subcategor√≠a
                                </label>
                                <select name="subcategory_id" id="subcategory_id" class="filter-select" onchange="this.form.submit()">
                                    <option value="">Todas las subcategor√≠as</option>
                                    {% for subcategory in subcategories %}
                                        {% if selected_category_id and subcategory.categoria_id == selected_category_id|int %}
                                            <option value="{{ subcategory.id }}" {% if selected_subcategory_id == subcategory.id|string %}selected{% endif %}>
                                                {{ subcategory.nombre }}
                                            </option>
                                        {% elif not selected_category_id %}
                                            <option value="{{ subcategory.id }}" {% if selected_subcategory_id == subcategory.id|string %}selected{% endif %}>
                                                {{ subcategory.nombre }}
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Grid de Productos -->
                {% if products %}
                    <div class="products-grid">
                        {% for product in products %}
                            <div class="product-card">
                                <div class="product-image-container">
                                    {% if product.url_imagen %}
                                        <img src="{{ product.url_imagen }}" class="product-image" alt="{{ product.nombre }}">
                                    {% else %}
                                        <img src="/static/images/placeholder.png" class="product-image" alt="Sin imagen">
                                    {% endif %}
                                    
                                    {% if product.stock < 10 and product.stock > 0 %}
                                        <div class="product-badge stock-low">¬°√öltimas unidades!</div>
                                    {% elif product.stock == 0 %}
                                        <div class="product-badge out-of-stock">Sin stock</div>
                                    {% else %}
                                        <div class="product-badge">{{ product.subcategoria.nombre if product.subcategoria else 'Producto' }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="product-info">
                                    <div class="product-category">
                                        {{ product.subcategoria.nombre if product.subcategoria else 'Sin categor√≠a' }}
                                    </div>
                                    <h3 class="product-title">{{ product.nombre }}</h3>
                                    <p class="product-description">{{ product.descripcion }}</p>
                                    <div class="product-price">${{ "%.2f"|format(product.precio) }}</div>
                                    <div class="product-stock {% if product.stock < 10 %}low{% endif %} {% if product.stock == 0 %}out{% endif %}">
                                        {% if product.stock > 0 %}
                                            Stock: {{ product.stock }} unidades
                                        {% else %}
                                            Sin stock disponible
                                        {% endif %}
                                    </div>
                                    
                                    <div class="product-actions">
                                        <button type="button" class="add-to-cart-btn" 
                                                data-product-id="{{ product.id }}" 
                                                {% if product.stock == 0 %}disabled{% endif %}>
                                            <i class="bi bi-cart-plus"></i>
                                            {% if product.stock == 0 %}Sin Stock{% else %}Agregar al Carrito{% endif %}
                                        </button>
                                        
                                        <button type="button" class="wishlist-btn" title="Agregar a favoritos">
                                            <i class="bi bi-heart"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <h3 class="empty-state-title">No se encontraron productos</h3>
                        <p class="empty-state-description">
                            {% if request.args.get('search') %}
                                No encontramos productos que coincidan con tu b√∫squeda.
                            {% else %}
                                Intenta ajustar los filtros o explora otras categor√≠as.
                            {% endif %}
                        </p>
                        {% if request.args.get('search') %}
                            <a href="{{ url_for('dashboard.client_dashboard') }}" class="btn btn-primary">
                                <i class="bi bi-arrow-left"></i> Ver todos los productos
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
            </main>
        </div>

    {% elif rol == 'vendedor' %}
        <!-- Panel de Vendedor -->
        <div class="admin-table-container">
            <div class="admin-table-header">
                <h3 class="admin-table-title">
                    <i class="bi bi-clock-history"></i> Pedidos Pendientes
                </h3>
            </div>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Pedido</th>
                        <th>Cliente</th>
                        <th>Monto</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% if pedidos %}
                        {% for pedido in pedidos %}
                            <tr>
                                <td><span class="badge badge-secondary">#{{ pedido.id }}</span></td>
                                <td>{{ pedido.usuario.nombre_usuario }}</td>
                                <td>${{ "%.2f"|format(pedido.monto_total) }}</td>
                                <td>
                                    <span class="status-badge status-{{ pedido.estado }}">
                                        {{ pedido.estado|title }}
                                    </span>
                                </td>
                                <td>
                                    <div class="table-actions">
                                        <button class="btn btn-primary btn-table">
                                            <i class="bi bi-eye"></i> Ver
                                        </button>
                                        <button class="btn btn-success btn-table">
                                            <i class="bi bi-check"></i> Procesar
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="empty-state">
                                <i class="bi bi-inbox" style="font-size: 2rem; opacity: 0.5;"></i>
                                <p>No hay pedidos pendientes.</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    {% endif %}
</div>

<script>
    // Manejo de filtros (solo para clientes)
    {% if rol == 'cliente' %}
    document.getElementById('category_id').addEventListener('change', function() {
        const categoryId = this.value;
        const subcategorySelect = document.getElementById('subcategory_id');
        subcategorySelect.innerHTML = '<option value="">Todas las subcategor√≠as</option>';
        
        if (categoryId) {
            fetch(`/subcategories/${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(subcat => {
                        const option = document.createElement('option');
                        option.value = subcat.id;
                        option.textContent = subcat.nombre;
                        subcategorySelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
    });

    // Manejo de agregar al carrito
    document.querySelectorAll('.add-to-cart-btn[data-product-id]').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const productId = this.getAttribute('data-product-id');
            const originalText = this.innerHTML;
            
            // Cambiar estado del bot√≥n
            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i> Agregando...';
            
            fetch(`/cart/add_to_cart/${productId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar mensaje de √©xito
                    this.innerHTML = '<i class="bi bi-check-circle"></i> ¬°Agregado!';
                    this.style.background = 'var(--success-color)';
                    
                    // Mostrar notificaci√≥n
                    showNotification(data.message, 'success');
                    
                    // Restaurar bot√≥n despu√©s de 2 segundos
                    setTimeout(() => {
                        this.disabled = false;
                        this.innerHTML = originalText;
                        this.style.background = '';
                    }, 2000);
                } else {
                    showNotification(data.message, 'error');
                    this.disabled = false;
                    this.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error al agregar al carrito', 'error');
                this.disabled = false;
                this.innerHTML = originalText;
            });
        });
    });

    // B√∫squeda en tiempo real (opcional)
    const searchInput = document.querySelector('.search-input');
    let searchTimeout;

    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length > 2) {
                searchTimeout = setTimeout(() => {
                    // Aqu√≠ podr√≠as implementar b√∫squeda en tiempo real con AJAX
                    console.log('Buscando:', query);
                }, 300);
            }
        });
    }
    {% endif %}

    // Funci√≥n para mostrar notificaciones
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.style.minWidth = '300px';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()">√ó</button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remover despu√©s de 5 segundos
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }
</script>

{% endblock %}
