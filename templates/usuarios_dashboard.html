{% extends 'base.html' %}
{% block title %}Panel de {{ rol|title }} - Bicicletería{% endblock %}
{% block content %}

{% if rol == 'cliente' %}
    <div class="hero">
        <div class="hero-background"></div>
        <div class="hero-content">
            <h1 class="hero-title">¡Bienvenido a nuestra Bicicletería!</h1>
            <p class="hero-subtitle">Descubre los mejores productos para tu bicicleta y vive la aventura sobre ruedas</p>
            <div class="hero-buttons">
                <a href="#products" class="hero-btn hero-btn-primary"><i class="fas fa-bicycle"></i> Explorar Productos</a>
                <a href="{{ url_for('cart.cart') }}" class="hero-btn hero-btn-outline"><i class="fas fa-shopping-cart"></i> Ver Carrito</a>
            </div>
            <p>¡Hola, {{ current_user.nombre_usuario }}! Explora nuestro catálogo.</p>
        </div>
    </div>

    <!-- Agregada sección de Nuestros Servicios -->
    <section class="services-section">
        <div class="container services-container">
            <div class="services-header">
                <h2 class="services-title">Nuestros Servicios</h2>
                <p class="services-subtitle">Ofrecemos servicios especializados para mantener tu bicicleta en perfectas condiciones y brindarte la mejor experiencia ciclística</p>
            </div>
            
            <div class="services-grid">
                <div class="service-card">
                    <div class="service-icon">
                        <i class="fas fa-tools"></i>
                    </div>
                    <h3 class="service-title">Mantenimiento Completo</h3>
                    <p class="service-description">Revisión integral de tu bicicleta, ajuste de frenos, cambios y lubricación de componentes para un rendimiento óptimo.</p>
                </div>
                
                <div class="service-card">
                    <div class="service-icon">
                        <i class="fas fa-wrench"></i>
                    </div>
                    <h3 class="service-title">Reparaciones Especializadas</h3>
                    <p class="service-description">Diagnóstico y reparación de averías complejas con técnicos especializados y repuestos originales de calidad.</p>
                </div>
                
                <div class="service-card">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <h3 class="service-title">Ensamblaje Personalizado</h3>
                    <p class="service-description">Armado de bicicletas a medida según tus necesidades y preferencias, con asesoramiento profesional incluido.</p>
                </div>
                
                <div class="service-card">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <h3 class="service-title">Entrega a Domicilio</h3>
                    <p class="service-description">Servicio de entrega rápida y segura de productos y bicicletas reparadas directamente en tu hogar.</p>
                </div>
                
                <div class="service-card">
                    <div class="service-icon">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <h3 class="service-title">Asesoramiento Técnico</h3>
                    <p class="service-description">Consultoría especializada para elegir la bicicleta perfecta y consejos de mantenimiento preventivo.</p>
                </div>
                
                <div class="service-card">
                    <div class="service-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3 class="service-title">Garantía Extendida</h3>
                    <p class="service-description">Protección adicional para tus compras con garantía extendida y soporte técnico continuo.</p>
                </div>
            </div>
        </div>
    </section>

    <div class="container">
        <div class="cart-table">
            <div class="cart-table-header">
                <h2 class="cart-title">Últimos Pedidos</h2>
                {% if pedidos %}
                    <p class="cart-count">{{ pedidos|length }} pedidos totales</p>
                {% endif %}
            </div>
            
            {% if pedidos %}
                {% for pedido in pedidos[:4] %}
                    <div class="cart-item">
                        <div class="cart-item-row">
                            <div class="cart-item-product">
                                <h4>Pedido #{{ pedido.id }}</h4>
                                <p>{{ pedido.fecha_creacion.strftime('%d/%m/%Y') if pedido.fecha_creacion else 'Fecha no disponible' }}</p>
                            </div>
                            <div>{{ pedido.estado|title }}</div>
                            <div>${{ "%.2f"|format(pedido.monto_total) }}</div>
                            <div>
                                <a href="{{ url_for('dashboard.pedido_detalle', pedido_id=pedido.id) }}" class="btn btn-primary">Ver detalles</a>
                                {% if pedido.estado == 'pagado' %}
                                    <a href="{{ url_for('cart.descargar_factura', pedido_id=pedido.id) }}" class="btn btn-primary">Descargar Factura</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
                {% if pedidos|length > 4 %}
                    <div class="cart-actions">
                        <a href="{{ url_for('dashboard.mis_pedidos') }}" class="btn btn-primary">Ver todos los pedidos</a>
                    </div>
                {% endif %}
            {% else %}
                <div class="empty-cart">
                    <i class="fas fa-shopping-cart empty-cart-icon"></i>
                    <h3>No tienes pedidos aún</h3>
                    <p>¡Explora nuestro catálogo y realiza tu primera compra!</p>
                    <a href="{{ url_for('products.catalog') }}" class="btn btn-primary">Explorar productos</a>
                </div>
            {% endif %}
        </div>
        <div class="products-section" id="products">
            <div class="section-header">
                <h2 class="section-title">Catálogo de Productos</h2>
                <p class="section-subtitle">Encuentra todo lo que necesitas para tu bicicleta</p>
            </div>

            <div class="search-container">
                <form class="search-form" method="GET" action="{{ url_for('dashboard.client_dashboard') }}">
                    <div class="search-input-group">
                        <input type="text" name="search" class="search-input" placeholder="Busca productos..." value="{{ request.args.get('search', '') }}">
                        <button type="submit" class="search-btn"><i class="fas fa-search"></i> Buscar</button>
                        {% if request.args.get('search') %}
                            <a href="{{ url_for('dashboard.client_dashboard') }}" class="search-clear-btn">×</a>
                        {% endif %}
                    </div>
                </form>
            </div>

            {% if request.args.get('search') %}
                <div class="search-results-info">
                    <i class="fas fa-search"></i> Resultados para: "{{ request.args.get('search') }}"
                </div>
            {% endif %}

            <div class="filters-container">
                <form method="POST" action="{{ url_for('dashboard.client_dashboard') }}">
                    <div class="filters-row">
                        <div class="filter-group">
                            <label class="filter-label">Filtrar por Categoría</label>
                            <select name="category_id" class="filter-select" onchange="updateSubcategories(this)">
                                <option value="">Todas las categorías</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}" {% if selected_category_id == category.id|string %}selected{% endif %}>{{ category.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Filtrar por Subcategoría</label>
                            <select name="subcategory_id" class="filter-select">
                                <option value="">Todas las subcategorías</option>
                                {% for subcategory in subcategories %}
                                    {% if selected_category_id and subcategory.categoria_id == selected_category_id|int %}
                                        <option value="{{ subcategory.id }}" {% if selected_subcategory_id == subcategory.id|string %}selected{% endif %}>{{ subcategory.nombre }}</option>
                                    {% elif not selected_category_id %}
                                        <option value="{{ subcategory.id }}" {% if selected_subcategory_id == subcategory.id|string %}selected{% endif %}>{{ subcategory.nombre }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
                    </div>
                </form>
            </div>

            <div class="products-grid">
                {% if products %}
                    {% for product in products %}
                        <div class="product-card">
                            {% if product.url_imagen %}
                                <div class="product-image-container">
                                    <img src="{{ product.url_imagen }}" alt="{{ product.nombre }}" class="product-image">
                                </div>
                            {% else %}
                                <div class="product-image-container">
                                    <img src="https://via.placeholder.com/280x200" alt="Placeholder" class="product-image">
                                </div>
                            {% endif %}
                            <div class="product-badge">
                                {% if product.stock < 10 and product.stock > 0 %}
                                    ¡Últimas unidades!
                                {% elif product.stock == 0 %}
                                    Sin stock
                                {% else %}
                                    {{ product.subcategoria.nombre if product.subcategoria else 'Producto' }}
                                {% endif %}
                            </div>
                            <div class="product-info">
                                <p class="product-category">{{ product.subcategoria.nombre if product.subcategoria else 'Sin categoría' }}</p>
                                <h3 class="product-title">{{ product.nombre }}</h3>
                                <p class="product-description">{{ product.descripcion }}</p>
                                <p class="product-price">${{ "%.2f"|format(product.precio) }}</p>
                                <p class="product-stock">
                                    {% if product.stock > 0 %}
                                        Stock: {{ product.stock }} unidades
                                    {% else %}
                                        Sin stock disponible
                                    {% endif %}
                                </p>
                                <div class="product-actions">
                                    <button class="add-to-cart-btn" {% if product.stock == 0 %}disabled{% endif %} data-product-id="{{ product.id }}">
                                        {% if product.stock == 0 %}Sin Stock{% else %}Agregar al Carrito{% endif %}
                                    </button>
                                    <button class="wishlist-btn {% if product.id in favorites %}favorited{% endif %}" data-product-id="{{ product.id }}">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-box-open empty-state-icon"></i>
                        <h3 class="empty-state-title">No se encontraron productos</h3>
                        <p class="empty-state-description">
                            {% if request.args.get('search') %}
                                No encontramos productos que coincidan con tu búsqueda.
                            {% else %}
                                Intenta ajustar los filtros o explora otras categorías.
                            {% endif %}
                        </p>
                        <a href="{{ url_for('dashboard.client_dashboard') }}" class="btn btn-primary">Ver todos los productos</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% elif rol == 'vendedor' %}
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Panel de Vendedor</h2>
            <p class="section-subtitle">Administra los pedidos y ventas</p>
        </div>
        <div class="orders-section">
            <div class="orders-table">
                <div class="table-header">
                    <div>Pedido</div>
                    <div>Cliente</div>
                    <div>Monto</div>
                    <div>Estado</div>
                    <div>Acciones</div>
                </div>
                {% if pedidos %}
                    {% for pedido in pedidos %}
                        <div class="table-row">
                            <div>#{{ pedido.id }}</div>
                            <div>{{ pedido.usuario.nombre_usuario }}</div>
                            <div>${{ "%.2f"|format(pedido.monto_total) }}</div>
                            <div>
                                <span class="badge badge-{{ pedido.estado }}">{{ pedido.estado|title }}</span>
                            </div>
                            <div>
                                <a href="{{ url_for('dashboard.pedido_detalle', pedido_id=pedido.id) }}" class="btn btn-primary">Ver</a>
                                <a href="{{ url_for('dashboard.procesar_pedido', pedido_id=pedido.id) }}" class="btn btn-primary">Procesar</a>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-box-open empty-state-icon"></i>
                        <h3 class="empty-state-title">No hay pedidos pendientes.</h3>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}
